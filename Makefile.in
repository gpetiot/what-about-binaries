
CAPSTONE=@CAPSTONE@

CAPSTONE_OBJ=\
	$(CAPSTONE)/arm_const.cmx \
	$(CAPSTONE)/arm.cmx \
	$(CAPSTONE)/capstone.cmx

SOURCES = src/hexa.mli src/hexa.ml \
	src/archi.mli src/archi.ml \
	src/endian.mli src/endian.ml \
	src/machine.mli src/machine.ml \
	src/program_header_type.mli src/program_header_type.ml \
	src/section_header_type.mli src/section_header_type.ml \
	src/symbol.mli src/symbol.ml \
	src/elf_header.mli src/elf_header.ml

EXEC_BYTE = obaf.byte
EXEC_OPT = obaf
EXECGUI_BYTE = obaf_gui.byte
EXECGUI_OPT = obaf_gui
CAMLC = ocamlc
CAMLOPT = ocamlopt
CAMLDEP = ocamldep
WITHGRAPHICS=graphics.cma -cclib -lgraphics -cclib -L/usr/X11R6/lib -cclib -lX11
WITHUNIX =unix.cma -cclib -lunix
WITHSTR =str.cma -cclib -lstr
WITHNUMS =nums.cma -cclib -lnums
WITHTHREADS =threads.cma -cclib -lthreads
WITHDBM =dbm.cma -cclib -lmldbm -cclib -lndbm
WITHCAPSTONE=-I $(CAPSTONE) $(CAPSTONE)/ocaml.o -cclib -lcapstone
LIBS=$(WITHCAPSTONE)
OBJS = $(SOURCES:.ml=.cmo)
OPTOBJS = $(SOURCES:.ml=.cmx)

all: $(EXEC_OPT)

$(EXEC_BYTE): $(SOURCES:.mli=.cmi) $(OBJS) src/main.cmo
	$(CAMLC) -I src -o $@ $(LIBS) $(OBJS) src/main.cmo

$(EXEC_OPT): $(SOURCES:.mli=.cmi) $(OPTOBJS) src/main.cmx
	$(CAMLOPT) -I src -o $@ $(LIBS:.cma=.cmxa) $(CAPSTONE_OBJ) $(OPTOBJS) src/main.cmx

src/main.cmo: src/main.ml
	$(CAMLC) -I src -c -annot $(LIBS) $<

src/main.cmx: src/main.ml
	$(CAMLOPT) -I src -c -annot $(LIBS:.cma=.cmxa) $<

src/%.cmo: src/%.ml src/%.cmi
	$(CAMLC) -I src -c -annot $<

src/%.cmi: src/%.mli
	$(CAMLC) -I src -c -annot $<

src/%.cmx: src/%.ml src/%.cmi
	$(CAMLOPT) -I src -c -annot $<

.PHONY: clean
clean:
	@rm -f src/*.cm[iox] src/*.o src/*.annot src/*~ *~ .*~ #*#
	@rm -f $(EXEC_BYTE) $(EXEC_OPT) $(EXECGUI_BYTE) $(EXECGUI_OPT)
	@rm -f configure config.log
	@rm -rf autom4te.cache
	@rm -f src/webgui.byte src/webgui/webgui.js
	make clean -C tests

.PHONY: gui
gui: $(EXECGUI_OPT)

$(EXECGUI_BYTE): $(SOURCES:.mli=.cmi) $(OBJS) src/gui/main.ml
	ocamlfind $(CAMLC) -I src -annot -g -package lablgtk2 -linkpkg $(LIBS) $(OBJS) src/gui/main.ml -o $@

$(EXECGUI_OPT): $(SOURCES:.mli=.cmi) $(OPTOBJS) src/gui/main.ml
	ocamlfind $(CAMLOPT) -I src -annot -g -package lablgtk2 -linkpkg $(LIBS:.cma=.cmxa) $(OPTOBJS) src/gui/main.ml -o $@

.PHONY: webgui
webgui: src/webgui/webgui.js

src/webgui.byte: $(OBJS) src/webgui.ml
	ocamlfind $(CAMLC) -I src -annot -package js_of_ocaml -syntax camlp4o -package js_of_ocaml.syntax -linkpkg -o $@ $(OBJS) $< src/webgui.ml

src/webgui/webgui.js: src/webgui.byte
	js_of_ocaml $< -o $@

.PHONY: tests
tests:
	make -C tests
